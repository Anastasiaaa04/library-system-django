{% extends 'base.html' %}

{% block title %}Профиль - Библиотека{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-body text-center">
                {% if reader.avatar %}
                    <img src="{{ reader.avatar.url }}" class="rounded-circle mb-3" alt="Аватар" style="width: 150px; height: 150px; object-fit: cover;">
                {% else %}
                    <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center mb-3" style="width: 150px; height: 150px;">
                        <i class="bi bi-person-circle h1 text-white"></i>
                    </div>
                {% endif %}
                <h4>{{ user.get_full_name|default:user.username }}</h4>
                <p class="text-muted">{{ user.email }}</p>
                <p class="mb-1"><i class="bi bi-telephone"></i> {{ reader.phone|default:"Не указан" }}</p>
                <p class="mb-1"><i class="bi bi-calendar"></i> Член с {{ reader.membership_date|date:"d.m.Y" }}</p>
                <p class="mb-1"><i class="bi bi-person-badge"></i> Статус: {% if reader.is_active %}<span class="badge bg-success">Активен</span>{% else %}<span class="badge bg-danger">Неактивен</span>{% endif %}</p>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Редактировать профиль</h5>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Телефон</label>
                        {{ form.phone }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Адрес</label>
                        {{ form.address }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Дата рождения</label>
                        {{ form.date_of_birth }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Аватар</label>
                        {{ form.avatar }}
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-save"></i> Сохранить изменения
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Текущие выдачи ({{ issued_books.count }})</h5>
            </div>
            <div class="card-body">
                {% if issued_books %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Книга</th>
                                    <th>Дата выдачи</th>
                                    <th>Срок возврата</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for issue in issued_books %}
                                    <tr>
                                        <td>{{ issue.book.title }}</td>
                                        <td>{{ issue.issue_date|date:"d.m.Y" }}</td>
                                        <td>
                                            {% if issue.due_date < now.date %}
                                                <span class="badge bg-danger">{{ issue.due_date|date:"d.m.Y" }}</span>
                                            {% else %}
                                                {{ issue.due_date|date:"d.m.Y" }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="{% url 'return_book' issue.id %}" class="btn btn-sm btn-warning">
                                                <i class="bi bi-box-arrow-in-left"></i> Вернуть
                                            </a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">У вас нет текущих выдач.</p>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">История чтения (последние 10)</h5>
            </div>
            <div class="card-body">
                {% if reading_history %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Книга</th>
                                    <th>Дата выдачи</th>
                                    <th>Дата возврата</th>
                                    <th>Статус</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for issue in reading_history %}
                                    <tr>
                                        <td>{{ issue.book.title }}</td>
                                        <td>{{ issue.issue_date|date:"d.m.Y" }}</td>
                                        <td>
                                            {% if issue.is_returned %}
                                                {{ issue.return_date|date:"d.m.Y" }}
                                            {% else %}
                                                <span class="badge bg-warning">Не возвращена</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if issue.is_returned %}
                                                <span class="badge bg-success">Возвращена</span>
                                            {% else %}
                                                <span class="badge bg-info">В процессе</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">История чтения пуста.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}